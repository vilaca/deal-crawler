name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit interrogate vulture pip-audit

      - name: Run tests
        run: |
          python -m unittest discover -s . -p 'test_*.py' -v

      - name: Run coverage
        run: |
          pytest --cov=. --cov-report=term

      - name: Lint with flake8
        run: |
          flake8 *.py

      - name: Type check with mypy
        run: |
          mypy *.py --ignore-missing-imports

      - name: Check code security with bandit
        run: |
          bandit -r *.py -ll > bandit-report.txt 2>&1 || true

      - name: Check for dead code with vulture
        run: |
          vulture *.py --min-confidence 100 > vulture-report.txt 2>&1 || true

      - name: Check docstring coverage
        run: |
          interrogate -v *.py --fail-under 100

      - name: Check dependency vulnerabilities
        run: |
          pip-audit --desc > pip-audit-report.txt 2>&1 || true

      - name: Post warnings as PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read reports
            const bandit = fs.existsSync('bandit-report.txt') ? fs.readFileSync('bandit-report.txt', 'utf8') : 'No issues found';
            const vulture = fs.existsSync('vulture-report.txt') ? fs.readFileSync('vulture-report.txt', 'utf8') : 'No dead code found';
            const pipaudit = fs.existsSync('pip-audit-report.txt') ? fs.readFileSync('pip-audit-report.txt', 'utf8') : 'No vulnerabilities found';

            // Check if there are actual warnings
            const hasBanditWarnings = !bandit.includes('No issues identified');
            const hasVultureWarnings = vulture.trim().length > 0 && !vulture.includes('No dead code');
            const hasPipAuditWarnings = pipaudit.includes('Found') && pipaudit.includes('vulnerability');

            // Only post if there are warnings
            if (!hasBanditWarnings && !hasVultureWarnings && !hasPipAuditWarnings) {
              console.log('No warnings to report');
              return;
            }

            // Build comment
            let comment = '## ‚ö†Ô∏è Code Quality Warnings\n\n';
            comment += '_These warnings do not block the PR but should be reviewed._\n\n';

            if (hasBanditWarnings) {
              comment += '### üîí Security Issues (bandit)\n';
              comment += '```\n' + bandit + '\n```\n\n';
            }

            if (hasVultureWarnings) {
              comment += '### üßπ Dead Code Detection (vulture)\n';
              comment += '```\n' + vulture + '\n```\n\n';
            }

            if (hasPipAuditWarnings) {
              comment += '### üì¶ Dependency Vulnerabilities (pip-audit)\n';
              comment += '```\n' + pipaudit + '\n```\n\n';
            }

            comment += '---\n';
            comment += '_Generated by [Deal Crawler CI](https://github.com/vilaca/deal-crawler)_';

            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "‚úÖ All quality checks passed!"
          else
            echo "‚ùå Some quality checks failed"
            exit 1
          fi
