name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          python -m unittest discover -s test -p 'test_*.py' -v

      - name: Run coverage
        run: |
          pytest --cov=utils --cov-report=term | tee coverage-output.txt

      - name: Update coverage badge
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Extract coverage percentage from output
          COVERAGE=$(grep "TOTAL" coverage-output.txt | awk '{print $4}' | sed 's/%//')

          if [ -n "$COVERAGE" ]; then
            echo "Coverage: $COVERAGE%"

            # Update README badge
            sed -i "s/coverage-[0-9]*%25/coverage-${COVERAGE}%25/" README.md

            # Check if README was modified
            if git diff --quiet README.md; then
              echo "Coverage badge already up to date"
            else
              # Configure git
              git config --local user.email "github-actions[bot]@users.noreply.github.com"
              git config --local user.name "github-actions[bot]"

              # Commit and push
              git add README.md
              git commit -m "Update coverage badge to ${COVERAGE}% [skip ci]"
              git push
            fi
          else
            echo "Could not extract coverage percentage"
          fi

      - name: Lint with flake8
        run: |
          flake8 main.py utils/*.py test/*.py

      - name: Lint with pylint
        run: |
          pylint main.py utils/*.py test/*.py --score=y > pylint-report.txt 2>&1 || true

      - name: Type check with mypy
        run: |
          mypy main.py utils/*.py test/*.py --ignore-missing-imports

      - name: Check code formatting with black
        run: |
          black --check main.py utils/*.py test/*.py > black-report.txt 2>&1 || true

      - name: Check code security with bandit
        run: |
          bandit -r main.py utils test -ll > bandit-report.txt 2>&1 || true

      - name: Check for dead code with vulture
        run: |
          vulture main.py utils test --min-confidence 100 > vulture-report.txt 2>&1 || true

      - name: Check docstring coverage
        run: |
          interrogate -v main.py utils test --fail-under 100

      - name: Check dependency vulnerabilities
        run: |
          pip-audit --desc > pip-audit-report.txt 2>&1 || true

      - name: Post warnings as PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read reports
            const black = fs.existsSync('black-report.txt') ? fs.readFileSync('black-report.txt', 'utf8') : 'No formatting issues';
            const pylint = fs.existsSync('pylint-report.txt') ? fs.readFileSync('pylint-report.txt', 'utf8') : 'No issues found';
            const bandit = fs.existsSync('bandit-report.txt') ? fs.readFileSync('bandit-report.txt', 'utf8') : 'No issues found';
            const vulture = fs.existsSync('vulture-report.txt') ? fs.readFileSync('vulture-report.txt', 'utf8') : 'No dead code found';
            const pipaudit = fs.existsSync('pip-audit-report.txt') ? fs.readFileSync('pip-audit-report.txt', 'utf8') : 'No vulnerabilities found';

            // Check if there are actual warnings
            const hasBlackWarnings = black.includes('would be reformatted') || black.includes('error');

            // Parse pylint score and check for issues
            const pylintScoreMatch = pylint.match(/Your code has been rated at ([\d.]+)\/10/);
            const pylintScore = pylintScoreMatch ? pylintScoreMatch[1] : null;
            const hasPylintWarnings = pylint.includes('************* Module') || (pylintScore && parseFloat(pylintScore) < 10.0);

            const hasBanditWarnings = !bandit.includes('No issues identified');
            const hasVultureWarnings = vulture.trim().length > 0 && !vulture.includes('No dead code');
            const hasPipAuditWarnings = pipaudit.includes('Found') && pipaudit.includes('vulnerability');

            // Only post if there are warnings
            if (!hasBlackWarnings && !hasPylintWarnings && !hasBanditWarnings && !hasVultureWarnings && !hasPipAuditWarnings) {
              console.log('No warnings to report');
              return;
            }

            // Build comment
            let comment = '## ‚ö†Ô∏è Code Quality Warnings\n\n';
            comment += '_These warnings do not block the PR but should be reviewed._\n\n';

            // Add pylint score at the top if available
            if (pylintScore) {
              const scoreEmoji = parseFloat(pylintScore) >= 9.5 ? '‚≠ê' : parseFloat(pylintScore) >= 8.0 ? '‚úÖ' : '‚ö†Ô∏è';
              comment += `### üéØ Code Quality Score: **${pylintScore}/10** ${scoreEmoji}\n\n`;
            }

            if (hasBlackWarnings) {
              comment += '### ‚ú® Code Formatting Issues (black)\n';
              comment += '```\n' + black + '\n```\n\n';
              comment += '_Run `make format` to fix formatting issues._\n\n';
            }

            if (hasPylintWarnings) {
              comment += '### üîç Code Quality Issues (pylint)\n';
              comment += '```\n' + pylint + '\n```\n\n';
            }

            if (hasBanditWarnings) {
              comment += '### üîí Security Issues (bandit)\n';
              comment += '```\n' + bandit + '\n```\n\n';
            }

            if (hasVultureWarnings) {
              comment += '### üßπ Dead Code Detection (vulture)\n';
              comment += '```\n' + vulture + '\n```\n\n';
            }

            if (hasPipAuditWarnings) {
              comment += '### üì¶ Dependency Vulnerabilities (pip-audit)\n';
              comment += '```\n' + pipaudit + '\n```\n\n';
            }

            comment += '---\n';

            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "‚úÖ All quality checks passed!"
          else
            echo "‚ùå Some quality checks failed"
            exit 1
          fi
